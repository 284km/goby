class Spec
  attr_accessor :session_successful
  attr_reader :describes

  def initialize
    @session_successful = true
    @describes = []
  end

  def self.describe(context_name)
    describes.push(Describe.new(context_name, get_block))
  end

  # Currently, it's not possible to implement a true singleton, as access levels are not yet
  # implemented.
  #
  def self.instance
    @instance ||= Spec.new
  end

  def self.test
    instance.test
  end

  def self.describes
    instance.describes
  end

  def test
    @describes.each do |describe|
      describe.test
    end

    if Spec.instance.session_successful
      exit
    else
      exit(1)
    end
  end
end

class Describe
  attr_reader :context_name, :examples

  def initialize(context_name, block)
    @context_name = context_name
    @describes = []
    @examples = []
    instance_eval block
  end

  def describe(context_name)
    describes.push(Describe.new(context_name, get_block))
  end

  def it(context_name)
    examples.push(Example.new(context_name, get_block))
  end

  def test
    puts context_name
    describes.each do |describe_node|
      puts "  " + describe_node.context_name
      describe_node.examples.each do |example_node|
        result_output = "    " + example_node.context_name
        if !example_node.test_result
          result_output += " (FAILED)"
          Spec.instance.session_successful = false
        end
        puts(result_output)
      end
    end
  end

  attr_accessor :describes
end

class Example
  attr_reader :context_name, :test_result

  def initialize(context_name, block)
    @context_name = context_name
    instance_eval block
  end

  def expect(result)
    @result = result
    self
  end

  def to(expectation)
    @test_result = expectation.call(result)
  end

  def not_to(expectation)
    @test_result = !expectation.call(result)
  end

  def eq(expectation)
    Block.new do |n|
      n == expectation
    end
  end

  attr_reader :result
end
